{{define "body"}} {{template "header"}}
<nav class="navbar navbar-expand navbar-dark bg-dark">
  <a class="navbar-brand" href="#"><img src="/imgs/nav_title.png"></a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMenu">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarMenu">
    <a class="navbar-brand" href="#" id="title"></a>
    <ul class="navbar-nav ml-auto">
      <a class="nav-link" href="javascript:history.go(-1)"><i class="fas fa-chevron-circle-left"></i></a>
    </ul>
  </div>
</nav>
<div class="container" style="padding-top:1em">
  <input type="hidden" id="bid" />
  <input type="hidden" id="uid" />
  <div class="row" style="margin-bottom:0.8rem">
	<div class="col col-3" style="padding-right:0">
	  <label for="creator"><b>创建者</b></label>
	  <input type="text" readonly class="form-control" id="creator" />
	</div>
	<div class="col col-9">
	  <label for="fee"><b>备注</b></label>
	  <div class="input-group" id="igmm">
		<input type="text" class="form-control" id="memo" value="0" />
	  </div>
	</div>
  </div>
  <div class="card border-success">
	<div class="card-header">
	  <div class="row">
		<div class="col"><b>药材清单</b></div>
		<div class="op col">
		  <i class="fas fa-cog float-right" style="padding-top:0.25rem" data-toggle="dropdown"></i>
		  <div class="dropdown-menu dropdown-menu-right">
			<a class="dropdown-item" href="#" id="viewstyle" value="0" onclick="switchVS()">切换为表格显示</a>
			<a class="dropdown-item" href="#" id="sortorder" value="0" onclick="switchSO()">切换为货架排序</a>
			<div class="dropdown-divider"></div>
			<a class="dropdown-item" href="#" id="docheckin" value="0" onclick="switchCI()">到货入库</a>
		  </div>
		</div>  
	  </div>
	</div>
	<div class="card-body">
	  <div class="row" style="margin-bottom: 1rem">
	    <div class="col col-9">
	      <input type="text" class="form-control" id="goods" placeholder="格式：品名 数量" />
	      <small class="form-text text-muted">可以输入品名或其拼音索引</small>
	    </div>
	    <div class="col col-3" style="padding-left:0">
		  <button style="width:100%" id="act" onclick="addGoods()" class="btn btn-success">添加</button>
		</div>
	  </div>
	  <p id="choice" style="display:none;font-family:monospace;padding:1rem 0.3rem 0.1rem 0.8rem;background:#eeeeee;border-radius:0.6rem"></p>
	  <p id="summary" style="font-weight:bold;text-decoration:underline"></p>
	  <p id="cart" style="font-family:monospace;font-size:large"></p>
	  <div id="unused" style="display:none">
		<p style="font-weight:bold">以下药材最近<span style="color:red">三个月未使用</span>，不建议采购：</p>
		<p id="list" style="font-family:monospace;font-size:large"></p>
	  </div>
	  <p id="wait" style="font-family:monospace;font-size:large"></p>
	  <p id="wip" style="font-family:monospace;font-size:large"></p>
	  <p id="done" style="font-family:monospace;font-size:large"></p>
	  <p id="chkin" style="display:none;text-align:center;margin-top:2rem">
		<button onclick="doneCheckIn()" class="btn btn-info">&nbsp;完成入库&nbsp;</button>
	  </p>
      <div id='diff' style="display:none">
        <p><b><u><span id="dfcnt"></span>种药材收货数量有差异，总计差额 <span id="dfamt"></span> 元</u></b></p>
		<p id="dfitems" style="font-family:monospace;font-size:large"></p>
		<p style="font-size:small"><i class="fas fa-info-circle"></i> 差额为正表示需要向供货方要求退款，为负表示应向供货方额外支付</p>
      </div>	  
	  <p id="finfo" class="mb-0 text-muted" style="font-size:small"></p>
	</div>
  </div>  
</div>
<div class="modal fade" id="editem" tabindex="-1" role="dialog">
  <input type=hidden id="gid" />
  <div class="modal-dialog modal-dialog-centered" role="document">
	<div class="modal-content">
	  <div class="modal-header">
		<h5 class="modal-title">编辑条目</h5>
		<button type="button" class="close" data-dismiss="modal">&times;</button>
	  </div>
	  <div class="modal-body">
	    <div class="form-group"><h4 id="gname"></h4></div>
	    <div class="form-group row">
		<div class="col">
		  <input type="text" class="form-control" id="count" />
		  <small class="form-text text-muted">数量（克）</small>
		</div>
		<div class="col">
		  <input type="text" class="form-control" id="price" />
		  <small class="form-text text-muted">价格（元/克）</small>
		</div>
	    </div>
	    <div class="modal-footer" style="padding-right:0;padding-bottom:0">
		<button type="button" class="btn btn-danger" data-dismiss="modal">删 除</button>
		<button type="button" class="btn btn-success" data-dismiss="modal">保 存</button>
	    </div>
	  </div>
	</div>
  </div>
</div>
<div class="modal fade" id="cfmdone" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
  	<div class="modal-content">
  	  <div class="modal-header">
  		<h5 class="modal-title">确认入库</h5>
  		<button type="button" class="close" data-dismiss="modal">&times;</button>
  	  </div>
  	  <div class="modal-body">
  		<p>某些药材的入库数量与订购量不符，如现在确认入库，将列出差异数量与金额。</p>
  		<div class="modal-footer" style="padding-right:0;padding-bottom:0">
  		  <button type="button" class="btn btn-secondary" data-dismiss="modal">取 消</button>
  		  <button type="button" class="btn btn-success" data-dismiss="modal">完 成</button>
  		</div>
  	  </div>
  	</div>
  </div>
</div>
<script>
var arg = {{.}}
function editItem(gid) {
	$('#choice').css('display', 'none')
	$('#editem #gid').val(gid)
    $('#editem').modal('show')
}
function switchVS() {
	if($('#viewstyle').attr('value') == "0") {
	  $('#viewstyle').attr('value', '1')
	  $('#viewstyle').text('切换为普通显示')
	} else {
	  $('#viewstyle').attr('value', '0')
      $('#viewstyle').text('切换为表格显示')
	}
	getBillInfo()
}
function switchSO() {
	if($('#sortorder').attr('value') == "0") {
	  $('#sortorder').attr('value', '1')
	  $('#sortorder').text('切换为后录在前')
	} else {
	  $('#sortorder').attr('value', '0')
      $('#sortorder').text('切换为货架排序')
	}
	getBillInfo()
}
function switchCI() {
	$('#unused').css("display", "none")
	switch($('#docheckin').attr('value')) {
	case "0":
      $('#docheckin').attr('value', '1')
	  $('#docheckin').text('暂停入库')
	  $('#act').val("入  库")
	  $('#act').removeClass('btn-success')
	  $('#act').addClass('btn-info')
	  break
	case "1":
	  $('#docheckin').attr('value', '0')
      $('#docheckin').text('到货入库')
	  $('#act').val('添  加')
	  $('#act').removeClass('btn-info')
	  $('#act').addClass('btn-success')
	  break
	case "2":
	  toast("错误", "尚有药材未设置价格，无法执行入库操作", "error")
	  return
	case "3":
      toast("错误", "该订单已经完成入库", "error")
	  return
	case "":
	  toast("错误", "没有添加药材，无法执行入库操作", "error")
	  return
	}
	getBillInfo()
}
function pick(ti, ii) {
    var t = $('body').data("rx_items")[ti]
    var ps = `${t.items[ii].name} ${t.weight}`
    if (t.memo != '') ps += `(${t.memo})`
    var g = $('#goods')
    g.val(`${g.val()} ${ps}`)
    if (!$('body').data('multi_rx'))
        addGoods() //当只有一个选项时，直接提交
}

function addGoods() {
	var act = $('#act')
	act.html(`<span class="spinner-border spinner-border-sm" role="status"></span>&nbsp;稍等...`)
	var rx = $('#goods').val().trim()
    $('#choice').empty()
    var memo = $('#memo').val()
    var id = $('#bid').val()
	var ci = $('#docheckin').attr('value')
	if (ci == 2) ci = 0 //服务端API不认识ci=2
    $.post(`/chkin/item/${id}`, {mode:ci, rx: rx}, function(e) {
	  $('body').data("rx_items", e.rx_items)
      var rxCnt = 0		
      $.each(e.rx_items, function(ti, rx) {
        var len = 0
        if (rx.items) len = rx.items.length
        switch(len) {
        case 0:
          $('#choice').append(`<p><span style='color:red'>${rx.term}</span> 没有找到</p>`)
          break
        case 1:
		  var it = rx.items[0]
          if (rx.weight<0 && ci == 0) {
            $('#choice').append(`<p><span style='color:red'>${it.name}</span> 已经添加了</p>`)
          } else if (ci == 1) {
			if (typeof(it.rack) != "undefined" && it.rack != null && it.rack.length > 0)
			  $('#choice').append(`<p><span style="color:purple">${it.name}</span>请放置于货架<span style="color:red">[${it.rack}]</span></p>`)
			else
			  $('#choice').append(`<p><span style="color:purple">${it.name}</span>未设置货架号！</span></p>`)
		  }
          break
        default:
          var choice = `<p><span style="color:red">${rx.term}</span> 是指`
          $.each(rx.items, function(ii, it) {
              choice += ` &nbsp;<a onclick="pick(${ti}, ${ii})" href="#">${it.name}</a>&nbsp; `
              if(ii < rx.items.length-1) choice += '还是'
          })
          choice += '?'
          $('#choice').append(choice)
		  rxCnt++
        }
      })
	  $('body').data("multi_rx", rxCnt > 1)
      getBillInfo()
	  if (typeof(e.unused) == 'object' && e.unused != null && e.unused.length > 0) {
		  var list = ""
		  $.each(e.unused, function(_, u) {
			  list += `${u.name} ${u.amount}克&nbsp; &nbsp;`
		  })	  
		  $('#unused #list').html(list)
		  $('#unused').css("display", "")
	  } else {
		  $('#unused').css("display", "none")
	  }
      if ($('#choice').is(':empty')) {
        $('#choice').css('display', 'none')
      } else { 
        $('#choice').css('display', '')
      }
      act.html(`添加`)
    })
}

function getBillInfo() {
  var bid = $('#bid').val()
  var so = $('#sortorder').attr('value')
  var vs = $('#viewstyle').attr('value')
  var ci = $('#docheckin').attr('value')
  $('#chkin').css('display', 'none')
  $('#act').attr("disabled", false)
  $('#goods').attr("disabled", false)
  $('#memo').attr("disabled", false)
  $('#finfo').text('')
  $.get(`/api/chkin/${bid}?order=${so}`, function(e) {
	if (e.bill.status == 1) {
		$('#title').text('进货单')
		var lack = []
		var dfcnt = 0
		var dfamt = 0
		$.each(e.items, function(_, it) {
		  var diff = it.request - it.confirm
		  if (Math.abs(diff) >= 0.01) {
			  lack.push({"name": it.gname, "diff": diff, "cost": it.cost})
			  dfcnt++
			  dfamt += diff * it.cost
		  }
		})
		if (lack.length > 0) {
		  $('#dfcnt').text(dfcnt)
		  $('#dfamt').text(dfamt)
		  $('#dfitems').empty()
		  switch(vs) {
		  case "0":
            $.each(lack, function(_, l) {
			  var diff = (l["diff"] > 0) ? `缺${l["diff"]}` : `多${-l["diff"]}`
              $('#dfitems').append(`<span>${l["name"]} ${diff}克 &nbsp; </span>`)
            })
			break
		  case "1":
		    var tbl = `<table class="table table-sm table-hover">
	          <thead class="thead-light"><tr><th>品名</th><th class="text-right">缺少</th>
	          <th class="text-right">单价</th><th class="text-right">总价</th></tr></thead><tbody>`
			$.each(lack, function(_, l) {
			  var total = l["diff"] * l["cost"]
			  tbl += `<tr><td>${l["name"]}</td><td class="text-right">${l["diff"]}</td>
				<td class="text-right">${l["cost"].toFixed(2)}</td>
				<td class="text-right">${total.toFixed(2)}</td></tr>`				
			})
			$('#dfitems').html(tbl)
		  }
		  $('#diff').css('display', '')
		}
		ci = 3 //表示订单已经完成，checkin菜单不可再用
		$('#act').attr("disabled", true)
		$('#goods').attr("disabled", true)
		$('#memo').attr("disabled", true)
		var upd = new Date(e.bill.changed * 1000)
		$('#finfo').text(`完成时间：${upd.toLocaleString()}`)
	}
	$('#goods').val('')
	$('#creator').val(e.user)
	$('#memo').val(e.bill.memo)
	$('#cart').empty()
	$('#wait').empty()
	$('#wip').empty()
	$('#done').empty()
	$('#summary').text('')
	if (e.items != null && e.items.length > 0) {
	  if (ci != "1") {
		if (ci != 3) ci = "0"
		$('#summary').text(`${e.bill.count}种药材，总价${e.bill.cost.toFixed(2)}元`)
		switch (vs) {
	    case "0":
	      $.each(e.items, function(_, item) {
			var cap = `${item.gname} ${item.request.toFixed(0)}克`
			if (e.bill.status == 0) {
			  var bg =  'white'
              if (item.cost == 0) {
            	  bg = 'lightpink'
            	  ci = '2'
              }
              $('#cart').append(`<a style="background:${bg}" href="#" onclick="editItem(${item.gid})"
                >${cap}</a> &nbsp; `)
			} else {
			  $('#cart').append(`${cap} &nbsp; `)  
			}
	      })
	      break
	    case "1":
	      var tbl = `<table class="table table-sm table-hover">
	    	<thead class="thead-light"><tr><th>品名</th><th class="text-right">数量</th>
	    	<th class="text-right">单价</th><th class="text-right">总价</th></tr></thead><tbody>`
	      $.each(e.items, function(_, item) {
	        var total = item.cost * item.request
			var bg =  'white'
			var name = item.gname
			if (typeof(item.rack) != 'undefined' && item.rack != null && item.rack.length > 0)
			  name = `[${item.rack}]${name}`
			if (e.bill.status == 0) {
	          if (item.cost == 0) {
	            bg = 'lightpink'
	            ci = '2'
	          }
			  name = `<a href="#" onclick="editItem(${item.gid})">${name}</a>`
			}
	        tbl += `<tr style="font-family:monospace;background:${bg}"><td>${name}</td>
			  <td class="text-right">${item.request}</td><td class="text-right">${item.cost.toFixed(2)}</td>
			  <td class="text-right">${total.toFixed(2)}</td></tr>`
	      })
	      tbl += `</tbody></table>`
	      $('#cart').append(tbl)
	    }
	    $('#docheckin').attr('value', ci)
	  } else {
		$('#chkin').css('display', '')
		$.each(e.items, function(i, it) {
			var req = it.request.toFixed(0)
			var cfm = it.confirm.toFixed(0)
			var name = it.gname
			if (typeof(it.rack) != 'undefined' && it.rack != null && it.rack.length > 0)
			  name = `[${it.rack}]${name}`
			if (Math.abs(cfm) < 0.01) {
				$('#wait').append(`${name} ${req}克 &nbsp; `)
			} else if (Math.abs(cfm - req) < 0.01) {
				$('#done').append(`${name} ${req}克 &nbsp; `)
			} else {
				$('#wip').append(`${name} ${req}克（入库${cfm}克） &nbsp; `)
			}
		})
		if (!$('#wait').is(':empty')) {
			$('#wait').prepend(`<p><b>未入库药材</b></p>`)
		}
		if (!$('#wip').is(':empty')) {
			$('#wip').prepend(`<p><b>部分入库药材</b></p>`)
		}
		if (!$('#done').is(':empty')) {
			$('#done').prepend(`<p><b>全部入库药材</b></p>`)
		}
	  }
	} else {
	  $('#docheckin').attr('value', "")	
	}
  })
}
function submitMemo() {
  var id = $('#bid').val()
  var memo = $('#memo').val()
  $.post(`/chkin/memo/${id}`, {memo: memo}, function(e) {
	$('#memo').attr('old', memo)
  })
  $('#chgm').remove()
}
function setCheckInDone() {
	var bid = $('#bid').val()
	$.post(`/api/chkin/${bid}`, {status: 1}, function(e) {
		getBillInfo()
	})
}
function doneCheckIn() {
	if (!$('#wait').is(':empty') || !$('#wip').is(':empty')) {
		$('#cfmdone').modal('show')
		return
	}
	setCheckInDone()
}
$(document).ready(function () {
  $('#uid').val(arg.user.id)
  $('#bid').val(Math.abs(arg.bill))
  if (arg.bill < 0) {
	$('#title').text('新建进货单')
	$('#creator').val(arg.user.name)
  } else {
	$('#title').text('编辑进货单')
  }
  getBillInfo()
  $('#goods').on('keypress', function (e) {
    if (e.which === 13) addGoods()
  })
  $('#memo').focus(function(e) {
      $('#memo').attr('old', $('#memo').val().trim())
  })
  $('#memo').keyup(function(e) {
	var old = $('#memo').attr('old')
	var txt = $('#memo').val().trim()
	$('#chgm').remove()
	if (e.which === 27) {
		$('#memo').val($('#memo').attr('old'))
		return
	}
	if (old == txt) return
	var btn = `<div class="input-group-append" id="chgm"><button onclick="submitMemo()"
        class="btn btn-outline-success border-left-0 border"type="button"><i
        class="fas fa-check"></i></button></div>`
    $('#igmm').append(btn)        
  })
  $('#editem').on('show.bs.modal', function(e) {
	var bid = $('#bid').val()
	var gid = $('#editem #gid').val()
	$.get(`/api/chkin/${bid}?item=${gid}`, function(e) {
		$('#editem #gname').text(e.gname)
		$('#editem #count').val(e.request)
		$('#editem #price').val(e.cost)
	})
  })
  $('#editem').on('hide.bs.modal', function (e) {
	var btn = $(document.activeElement)
	var bid = $('#bid').val()
	var gid = $('#editem #gid').val()
	var cnt = $('#editem #count').val()
	var price = $('#editem #price').val()
    if (btn.hasClass("btn-success")) {
      $.post(`/api/chkin/${bid}`, {gid:gid,cost:price,request:cnt}, function(e) {
		getBillInfo()
	  })
	}
	if (btn.hasClass("btn-danger")) {
		var bid = $('#bid').val()
		var gid = $('#editem #gid').val()
		$.ajax({
            url: `/api/chkin/${bid}/${gid}`,
            type: 'DELETE',
            complete: function(xhr) {
              if (xhr.status != 200)
                toast("操作失败", xhr.responseText, 'error')
			  else
			    getBillInfo() 
            }
        })
	}
  })
  $('#cfmdone').on('hide.bs.modal', function(e) {
    var btn = $(document.activeElement)
    if (btn.hasClass("btn-success"))
		setCheckInDone()
  })
})
</script>
{{template "footer"}} {{end}}