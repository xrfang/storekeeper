{{define "body"}} {{template "header"}}
<nav class="navbar navbar-expand navbar-dark bg-dark">
  <a class="navbar-brand" href="#"><img src="/imgs/nav_title.png"></a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMenu">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarMenu">
    <a class="navbar-brand" href="#" id="title"></a>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown">
          <i class="fas fa-bars"></i>
        </a>
        <div class="dropdown-menu dropdown-menu-right">
          <a class="dropdown-item" href="/chkin"><i class="fas fa-file-powerpoint"></i>&nbsp;进货单管理</a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" href="/logout"><i class="fas fa-door-open"></i>&nbsp;退出</a>
        </div>
      </li>
    </ul>
  </div>
</nav>
<div class="container" style="padding-top:1em">
  <input type="hidden" id="bid" />
  <input type="hidden" id="uid" />
  <div class="row" style="margin-bottom:0.8rem">
	<div class="col col-3" style="padding-right:0">
	  <label for="creator"><b>创建者</b></label>
	  <input type="text" readonly class="form-control" id="creator" />
	</div>
	<div class="col col-9">
	  <label for="fee"><b>备注</b></label>
	  <input type="text" class="form-control" id="memo" value="0" />
	</div>	
  </div>
  <div class="card border-success">
	<div class="card-header">
	  <div class="row">
		<div class="col"><b>货品清单</b></div>
		<div class="op col">
		  <i class="fas fa-cog float-right" style="padding-top:0.25rem" data-toggle="dropdown"></i>
		  <div class="dropdown-menu dropdown-menu-right">
			<a class="dropdown-item" href="#" id="viewstyle" value="0" onclick="switchVS()">切换为表格显示</a>
			<a class="dropdown-item" href="#" id="sortorder" value="0" onclick="switchSO()">切换为拼音排序</a>
		  </div>			
		</div>  
	  </div>
	</div>
	<div class="card-body">
	  <div class="row" style="margin-bottom: 1rem">
	    <div class="col col-9">
	      <input type="text" class="form-control" id="goods" placeholder="格式：品名 数量" />
	      <small class="form-text text-muted">可以输入品名或其拼音索引</small>
	    </div>
	    <div class="col col-3" style="padding-left:0">
          <input style="width:100%" type=button onclick="addGoods()" class="btn btn-success" value="添 加" />
	    </div>
	  </div>
	  <p id="choice" style="display:none;padding:1rem 0.3rem 0.1rem 0.8rem;background:#eeeeee;border-radius:0.6rem"></p>
	  <p id="cart"></p>			
	</div>
  </div>  
</div>
<script>
var arg = {{.}}
function switchVS() {
	if($('#viewstyle').attr('value') == "0") {
	  $('#viewstyle').attr('value', '1')
	  $('#viewstyle').text('切换为行式显示')
	} else {
	  $('#viewstyle').attr('value', '0')
      $('#viewstyle').text('切换为表格显示')
	}
	getBillInfo()
}
function switchSO() {
	if($('#sortorder').attr('value') == "0") {
	  $('#sortorder').attr('value', '1')
	  $('#sortorder').text('切换为后录在前')
	} else {
	  $('#sortorder').attr('value', '0')
      $('#sortorder').text('切换为拼音排序')
	}
	getBillInfo()
}
function pick(item, cnt) {
	var name = $(item).text()
	$('#goods').val(`${name} ${cnt}`)
	addGoods()
}
function addGoods() {
	var spec = $('#goods').val().trim().split(/\s+/)
	if (spec.length != 2) {
		toast("输入错误", "示例: “甘草 500”表示“500克甘草”", "warning")
		return
	}
	var item = spec[0]
	var cnt = parseInt(spec[1])
	if (isNaN(cnt) || (cnt <= 0)) {
		toast("输入错误", "数量必须是大于0的整数", "warning")
		return
	}
	var memo = $('#memo').val()
	var id = $('#bid').val()
	$('#choice').empty()
	$('#cart').empty()
	$.post(`/api/bom/${id}`, {item:item,count:cnt,fee:fee,memo:memo}, function(e) {
		switch (e.item.length) {
		case 0:
    	  $('#choice').append(`<p><span style='color:red'>${item}</span> 没有找到</p>`)
		  break
		case 1:
		  break
		default:
    	  var choice = `<p><span style="color:red">${item}</span> 是指`
    	  $.each(e.item, function(i, it) {
		  	choice += ` &nbsp;<a onclick="pick(this, ${cnt})" href="#">${it}</a>&nbsp; `
		  	if(i < e.item.length-1) choice += '还是'
		  })
		  choice += '?'
		  $('#choice').append(choice)	
		}
		getBillInfo()
		if ($('#choice').is(':empty')) {
		    $('#choice').css('display', 'none')
		} else { 
		    $('#choice').css('display', '')
		}		
	})
}
function getBillInfo() {
  var bid = $('#bid').val()
  var so = $('#sortorder').attr('value')
  $.get(`/api/bom/${bid}?order=${so}`, function(e) {
	$('#goods').val('')
	$('#creator').val(e.user)
	$('#memo').val(e.bill.memo)
	$('#cart').empty()
	if (e.items.length > 0) {
	  switch ($('#viewstyle').attr('value')) {
	  case "0":
	    $.each(e.items, function(_, item) {
	      $('#cart').append(`<a href="#">${item.gname} ${item.count}克</a> &nbsp; `)
	    })
	    break
	  case "1":
		var tbl = `<table class="table table-sm table-hover">
			<thead class="thead-light"><tr><th>品名</th><th class="text-right">数量</th>
			<th class="text-right">单价</th><th class="text-right">总价</th></tr></thead><tbody>`
		$.each(e.items, function(_, item) {
		  tbl += `<tr><td>${item.gname}</td><td class="text-right">${item.count}</td>
			<td class="text-right">--</td><td class="text-right">--</td></tr>`
		})
		tbl += `</tbody></table>`
		$('#cart').append(tbl)
	  }
	}
  })
}

$(document).ready(function () {
  $('#uid').val(arg.user.id)
  if (arg.bill == 0) {
	$('#title').text('新建进货单')
	$('#creator').text(arg.user.name)
	$('#bid').val(0)
	$('#creator').val(arg.user.name)
  } else {
	$('#title').text('编辑进货单')
	$('#bid').val(arg.bill)
	getBillInfo()
  }
  $('#goods').on('keypress', function (e) {
    if (e.which === 13) addGoods()
  })
})
</script>
{{template "footer"}} {{end}}